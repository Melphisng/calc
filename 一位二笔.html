<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Áè†ÂøÉÁÆóÁªÉ‰π†Ôºà‰∏Ä‰Ωç‰∫åÁ¨îÂä†ÂáèÔºâ / Abacus Practice (One-Digit Two-Step Addition/Subtraction)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            touch-action: manipulation;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 100%;
            box-sizing: border-box;
            position: relative;
        }
        .problem {
            font-size: 24px;
            margin: 10px 0;
            text-align: center;
        }
        .problem span {
            display: inline-block;
            width: 40px;
            text-align: right;
        }
        input[type="number"], input[type="text"] {
            padding: 10px;
            font-size: 18px;
            margin: 10px;
            width: 100px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        button {
            padding: 12px 24px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            touch-action: manipulation;
            display: block;
            margin-left: auto;
            margin-right: auto;
            min-height: 48px;
        }
        button:hover {
            background-color: #45a049;
        }
        #shareButton {
            background-color: #1a73e8;
        }
        #shareButton:hover {
            background-color: #1557b0;
        }
        #pdfButton {
            background-color: #FF5722;
        }
        #pdfButton:hover {
            background-color: #E64A19;
        }
        #result, #setupError {
            font-size: 18px;
            margin-top: 10px;
            color: red;
        }
        #encouragement {
            font-size: 18px;
            margin: 10px 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .correct { color: green; }
        .incorrect { color: red; }
        .keyboard {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 10px auto;
            max-width: 300px;
        }
        .keyboard button {
            padding: 15px;
            font-size: 20px;
            background-color: #666666;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            min-height: 48px;
            transition: background-color 0.1s, transform 0.1s;
        }
        .keyboard button:active {
            transform: scale(0.95);
            background-color: #555555 !important;
        }
        .keyboard .zero-button {
            grid-column: 2;
        }
        .keyboard .delete-button {
            grid-column: 3;
            background-color: #ff0000 !important;
        }
        .keyboard .delete-button:active {
            background-color: #cc0000 !important;
        }
        #shareArea {
            background-color: white;
            padding: 10px;
        }
        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .lang-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            padding: 5px 10px;
            background-color: #008CBA;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lang-toggle:hover {
            background-color: #007399;
        }
        @media (max-width: 600px) {
            .problem {
                font-size: 20px;
            }
            input[type="number"], input[type="text"] {
                font-size: 16px;
                width: 80px;
            }
            button {
                font-size: 16px;
                padding: 10px 30px;
            }
            #submitButton, #startButton {
                width: 240px;
            }
            .keyboard {
                display: grid;
            }
            .keyboard button {
                padding: 20px;
                font-size: 24px;
            }
            .keyboard .delete-button {
                padding: 15px;
                font-size: 20px;
            }
            #encouragement {
                font-size: 16px;
            }
            .footer {
                font-size: 10px;
            }
            .lang-toggle {
                font-size: 14px;
                width: 25px;
                height: 25px;
                padding: 4px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <button class="lang-toggle" id="langToggle" onclick="toggleLanguage()" style="display: none;">üåê</button>
        <div id="setup" style="display: block;">
            <label for="numQuestions">ÈÄâÊã©È¢òÁõÆÊï∞Èáè / Select Number of Questions:</label>
            <select id="numQuestions">
                <option value="10">10</option>
                <option value="40">40</option>
                <option value="80">80</option>
                <option value="120">120</option>
                <option value="160">160</option>
                <option value="200">200</option>
                <option value="240">240</option>
            </select>
            <button id="startButton" type="button" onclick="startPractice()" ontouchstart="">ÂºÄÂßãÁªÉ‰π† / Start Practice</button>
            <div id="setupError"></div>
        </div>
        <div id="practice" style="display: none;">
            <h2 id="questionTitle">Á¨¨ <span id="currentQuestion">1</span> È¢ò / Question <span id="currentQuestion">1</span></h2>
            <div id="problem" class="problem"></div>
            <input type="number" id="answer" placeholder="ËæìÂÖ•Á≠îÊ°à / Enter Answer">
            <div class="keyboard" id="keyboard">
                <button data-key="7">7</button>
                <button data-key="8">8</button>
                <button data-key="9">9</button>
                <button data-key="4">4</button>
                <button data-key="5">5</button>
                <button data-key="6">6</button>
                <button data-key="1">1</button>
                <button data-key="2">2</button>
                <button data-key="3">3</button>
                <button class="zero-button" data-key="0">0</button>
                <button class="delete-button" data-key="delete">‚å´</button>
            </div>
            <button id="submitButton" type="button" onclick="checkAnswer()" ontouchstart="">Êèê‰∫§ / Submit</button>
            <div id="result"></div>
        </div>
        <div id="summary" style="display: none;">
            <div id="shareArea">
                <h2 id="practiceResults">ÁªÉ‰π†ÁªìÊûú</h2>
                <p><span id="nameLabel">ÂßìÂêç</span>Ôºö<span id="userNameDisplay"></span></p>
                <p><span id="correctCountLabel">Á≠îÂØπÈ¢òÊï∞</span>Ôºö<span id="correctCount"></span></p>
                <p><span id="totalTimeLabel">ÊÄªÁî®Êó∂</span>Ôºö<span id="totalTime"></span></p>
                <p><span id="completionTimeLabel">ÂÆåÊàêÊó∂Èó¥</span>Ôºö<span id="completionTime"></span></p>
            </div>
            <p id="encouragement"></p>
            <button id="shareButton" type="button" onclick="shareResult()" ontouchstart="">ÂàÜ‰∫´</button>
            <button id="pdfButton" type="button" onclick="generatePDF()" ontouchstart="">ÁîüÊàêPDFÊä•Âëä</button>
            <button id="returnHomeButton" type="button" onclick="returnToHome()" ontouchstart="">ËøîÂõûÁõÆÂΩï</button>
            <h3 id="analysisTitle">È¢òÁõÆÂàÜÊûê</h3>
            <table>
                <thead>
                    <tr>
                        <th id="problemHeader">È¢òÁõÆ</th>
                        <th id="userAnswerHeader">‰Ω†ÁöÑÁ≠îÊ°à</th>
                        <th id="correctnessHeader">Ê≠£Á°ÆÊÄß</th>
                        <th id="correctAnswerHeader">Ê≠£Á°ÆÁ≠îÊ°à</th>
                    </tr>
                </thead>
                <tbody id="summaryTable"></tbody>
            </table>
        </div>
        <div class="footer">
            <p id="author"><span>‰ΩúËÄÖÔºöÈ¢úÊØÖÁøî<br>Author: Melphis Ng</span></p>
            <p id="aiUsage"><span>AI Â∑•ÂÖ∑‰ΩøÁî®ÔºöÈÉ®ÂàÜ‰ª£Á†ÅÁî± AIÔºàGrok 3ÔºâËæÖÂä©ÁîüÊàêÔºåÂàõÊÑè‰∏éÈÄªËæëÁî±‰ΩúËÄÖÊûÑÊÄù„ÄÇ<br>AI Tool Usage: Part of the code was generated with the assistance of AI (Grok 3), with creativity and logic conceived by the author.</span></p>
        </div>
    </div>
    <canvas id="shareCanvas" style="display: none;"></canvas>

    <script>
        let problems = [];
        let currentIndex = 0;
        let startTime;
        let numQuestions;
        let userName = localStorage.getItem('userName') || 'Êú™Áü•';
        let language = localStorage.getItem('language') || 'zh';
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let lastInputTime = 0;
        const debounceDelay = 100;

        const encouragementsByPercentage = {
            below10: {
                zh: [
                    "Âà´ÁÅ∞ÂøÉÔºÅÊØè‰∏ÄÊ¨°Â∞ùËØïÈÉΩÂú®ËÆ©‰Ω†Êõ¥Âº∫ÔºåÁªßÁª≠Âä™ÂäõÂì¶ÔºÅ",
                    "Â∞èÂ∞èÊå´Êäò‰∏çÁÆóÂï•ÔºåÂ§öÁªÉ‰π†Âá†Ê¨°Ôºå‰Ω†‰ºöË∂äÊù•Ë∂äÊ£íÔºÅ",
                    "ÂùöÊåÅÂ∞±ÊòØËÉúÂà©ÔºÅÂÜçÂ§öËØïËØïÔºå‰Ω†‰∏ÄÂÆöËÉΩËøõÊ≠•ÁöÑÔºÅ",
                    "ÊØè‰∏ÄÊ≠•ÈÉΩÂú®Èù†ËøëÁõÆÊ†áÔºåÂä†Ê≤πÔºå‰Ω†ÂèØ‰ª•ÁöÑÔºÅ"
                ],
                en: [
                    "Don't be discouraged! Every attempt makes you stronger, keep trying!",
                    "A little setback is nothing, practice more and you'll get better!",
                    "Persistence is victory! Try a bit more, and you'll definitely improve!",
                    "Every step brings you closer to your goal, keep it up, you can do it!"
                ]
            },
            from10to40: {
                zh: [
                    "‰∏çÈîôÂì¶ÔºÅ‰∏ãÊ¨°ÂÜçÂä™Âäõ‰∏ÄÁÇπÔºåÊàêÁª©‰ºöÊõ¥Â•ΩÔºÅ",
                    "‰Ω†Â∑≤ÁªèËøàÂá∫‰∫ÜÁ¨¨‰∏ÄÊ≠•ÔºåÁªßÁª≠Âä†Ê≤πÂêßÔºÅ",
                    "ËøõÊ≠•Ê≠£Âú®Ë∑Ø‰∏äÔºå‰∏ãÊ¨°‰∏ÄÂÆö‰ºöÊúâÊÉäÂñúÔºÅ",
                    "ÂÜçÂ§öÁªÉ‰π†Âá†Ê¨°Ôºå‰Ω†‰ºöÂèëÁé∞Ëá™Â∑±Ë∂äÊù•Ë∂äÂéâÂÆ≥ÔºÅ"
                ],
                en: [
                    "Nice job! Try a bit harder next time, and your score will improve!",
                    "You've taken the first step, keep pushing forward!",
                    "Progress is on the way, next time will bring surprises!",
                    "Practice a few more times, and you'll see how awesome you can be!"
                ]
            },
            from40to60: {
                zh: [
                    "Âæà‰∏çÈîôÔºÅÂÜçÂä†ÊääÂä≤Ôºå‰Ω†‰ºöÊõ¥Âá∫Ëâ≤ÔºÅ",
                    "Â∑≤ÁªèÂæàÊ£í‰∫ÜÔºåÁªßÁª≠Âä™Âäõ‰ºöÊúâÊõ¥Â§ßËøõÊ≠•ÔºÅ",
                    "‰Ω†ÁöÑË°®Áé∞Âæà‰∫ÆÁúºÔºåÂÜçÊé•ÂÜçÂéâÂì¶ÔºÅ",
                    "ÊàêÁª©ÂæàÂèØËßÇÔºåÁªßÁª≠‰øùÊåÅÔºåËøõÊ≠•Á©∫Èó¥ËøòÂæàÂ§ßÔºÅ"
                ],
                en: [
                    "Very nice! Push a little more, and you'll shine even brighter!",
                    "Already great, keep working and you'll make even bigger progress!",
                    "Your performance is impressive, keep up the momentum!",
                    "Solid results, stay consistent, there's still room to grow!"
                ]
            },
            from60to80: {
                zh: [
                    "Â§™‰ºòÁßÄ‰∫ÜÔºÅ‰øùÊåÅÂäøÂ§¥ÔºåÁªßÁª≠Âä†Ê≤πÔºÅ",
                    "‰Ω†ÁöÑË°®Áé∞ÂæàÊ£íÔºåÁªßÁª≠Âä™Âäõ‰ºöÊõ¥ÂéâÂÆ≥ÔºÅ",
                    "ÁúüÊòØ‰∏™Â∞èËÉΩÊâãÔºÅÂÜçÊé•ÂÜçÂéâÔºåÊú™Êù•ÂèØÊúüÔºÅ",
                    "ÊàêÁª©ÂæàÂá∫Ëâ≤ÔºåÁªßÁª≠‰øùÊåÅ‰Ω†ÁöÑÂ•ΩÁä∂ÊÄÅÔºÅ"
                ],
                en: [
                    "So excellent! Keep the momentum going, you got this!",
                    "Your performance is awesome, keep trying to be even better!",
                    "You're a real pro! Keep it up, the future looks bright!",
                    "Outstanding results, maintain that great form!"
                ]
            },
            from80to100: {
                zh: [
                    "ÈùûÂ∏∏Ê£íÔºÅ‰Ω†ÁöÑÂä™ÂäõËÆ©‰∫∫‰Ω©ÊúçÔºåÁªßÁª≠‰øùÊåÅÔºÅ",
                    "Â§™ÂéâÂÆ≥‰∫ÜÔºÅÂÜçÊé•ÂÜçÂéâÔºå‰Ω†‰ºöÊõ¥‰ºòÁßÄÔºÅ",
                    "ÊàêÁª©Ë∂ÖÁ∫ßÊ£íÔºåÁªßÁª≠Âä™ÂäõÔºåÊú™Êù•Êõ¥Á≤æÂΩ©ÔºÅ",
                    "‰Ω†Â∑≤ÁªèÂæàÊé•ËøëÂÆåÁæé‰∫ÜÔºåÁªßÁª≠Âä†Ê≤πÂì¶ÔºÅ"
                ],
                en: [
                    "Absolutely fantastic! Your effort is admirable, keep it up!",
                    "Super impressive! Keep pushing, you'll be even better!",
                    "Amazing results, keep working, your future is bright!",
                    "You're so close to perfect, keep fueling your effort!"
                ]
            },
            fullMarks: {
                zh: [
                    "ÁúüÊòØÂ§©ÊâçÔºÅÂÆåÁæéË°®Áé∞ÔºåÂ§™‰∫Ü‰∏çËµ∑‰∫ÜÔºÅ",
                    "Êª°ÂàÜÔºÅ‰Ω†ÊòØÁè†ÂøÉÁÆóÁöÑË∂ÖÁ∫ßÊòéÊòüÔºÅ",
                    "Êó†‰∏é‰º¶ÊØîÁöÑÂ§©ÊâçÔºÅÁªßÁª≠‰øùÊåÅ‰Ω†ÁöÑÂÖâËäíÔºÅ",
                    "ÂÆåÁæéÊàêÁª©ÔºÅ‰Ω†ÁÆÄÁõ¥ÊòØÊï∞Â≠¶Â∞èÂ§©ÊâçÔºÅ"
                ],
                en: [
                    "You're a genius! Perfect performance, absolutely amazing!",
                    "Full marks! You're a mental math superstar!",
                    "Unmatched genius! Keep shining bright!",
                    "Perfect score! You're truly a math prodigy!"
                ]
            }
        };

        const translations = {
            zh: {
                selectQuestions: 'ÈÄâÊã©È¢òÁõÆÊï∞Èáè',
                startPractice: 'ÂºÄÂßãÁªÉ‰π†',
                question: 'Á¨¨ {n} È¢ò',
                enterAnswer: 'ËæìÂÖ•Á≠îÊ°à',
                submit: 'Êèê‰∫§',
                practiceResults: 'ÁªÉ‰π†ÁªìÊûú',
                name: 'ÂßìÂêç',
                correctCount: 'Á≠îÂØπÈ¢òÊï∞',
                totalTime: 'ÊÄªÁî®Êó∂',
                completionTime: 'ÂÆåÊàêÊó∂Èó¥',
                share: 'ÂàÜ‰∫´',
                generatePDF: 'ÁîüÊàêPDFÊä•Âëä',
                returnHome: 'ËøîÂõûÁõÆÂΩï',
                analysisTitle: 'È¢òÁõÆÂàÜÊûê',
                problemHeader: 'È¢òÁõÆ',
                userAnswerHeader: '‰Ω†ÁöÑÁ≠îÊ°à',
                correctnessHeader: 'Ê≠£Á°ÆÊÄß',
                correctAnswerHeader: 'Ê≠£Á°ÆÁ≠îÊ°à',
                correct: 'Ê≠£Á°Æ',
                incorrect: 'ÈîôËØØ',
                seconds: 'Áßí',
                errorNoName: 'ËØ∑ÂÖàÂú®‰∏ªÈ°µËÆæÁΩÆÂßìÂêçÔºÅ',
                errorEnterAnswer: 'ËØ∑ËæìÂÖ•Á≠îÊ°àÔºÅ',
                title: 'Áè†ÂøÉÁÆóÁªÉ‰π†Ôºà‰∏Ä‰Ωç‰∫åÁ¨îÂä†ÂáèÔºâ',
                reportTitle: 'Áè†ÂøÉÁÆóÁªÉ‰π†ÁªìÊûú',
                reportSubtitle: 'Ôºà‰∏Ä‰Ωç‰∫åÁ¨îÂä†ÂáèÔºâ',
                shareText: 'ÁúãÁúãÊàëÁöÑÁè†ÂøÉÁÆóÁªÉ‰π†ÊàêÁª©ÔºÅ',
                author: '‰ΩúËÄÖÔºöÈ¢úÊØÖÁøî',
                aiUsage: 'AI Â∑•ÂÖ∑‰ΩøÁî®ÔºöÈÉ®ÂàÜ‰ª£Á†ÅÁî± AIÔºàGrok 3ÔºâËæÖÂä©ÁîüÊàêÔºåÂàõÊÑè‰∏éÈÄªËæëÁî±‰ΩúËÄÖÊûÑÊÄù„ÄÇ'
            },
            en: {
                selectQuestions: 'Select Number of Questions',
                startPractice: 'Start Practice',
                question: 'Question {n}',
                enterAnswer: 'Enter Answer',
                submit: 'Submit',
                practiceResults: 'Practice Results',
                name: 'Name',
                correctCount: 'Correct Answers',
                totalTime: 'Total Time',
                completionTime: 'Completion Time',
                share: 'Share',
                generatePDF: 'Generate PDF Report',
                returnHome: 'Return to Home',
                analysisTitle: 'Question Analysis',
                problemHeader: 'Question',
                userAnswerHeader: 'Your Answer',
                correctnessHeader: 'Correctness',
                correctAnswerHeader: 'Correct Answer',
                correct: 'Correct',
                incorrect: 'Incorrect',
                seconds: 'seconds',
                errorNoName: 'Please set a name first!',
                errorEnterAnswer: 'Please enter an answer!',
                title: 'Abacus Practice (One-Digit Two-Step Addition/Subtraction)',
                reportTitle: 'Abacus Practice Results',
                reportSubtitle: '(One-Digit Two-Step Addition/Subtraction)',
                shareText: 'Check out my abacus practice results!',
                author: 'Author: Melphis Ng',
                aiUsage: 'AI Tool Usage: Part of the code was generated with the assistance of AI (Grok 3), with creativity and logic conceived by the author.'
            }
        };

        function toggleLanguage() {
            language = language === 'zh' ? 'en' : 'zh';
            localStorage.setItem('language', language);
            showSummary();
        }

        function inputKey(key) {
            const now = Date.now();
            if (now - lastInputTime < debounceDelay) return;
            lastInputTime = now;
            const input = document.getElementById('answer');
            if (key === 'delete') {
                input.value = '';
            } else {
                input.value += key;
            }
            if (isMobile && 'vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        function formatDateTime(date) {
            const offset = 8 * 60;
            const localDate = new Date(date.getTime() + offset * 60 * 1000);
            const year = localDate.getUTCFullYear();
            const month = String(localDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(localDate.getUTCDate()).padStart(2, '0');
            const hours = String(localDate.getUTCHours()).padStart(2, '0');
            const minutes = String(localDate.getUTCMinutes()).padStart(2, '0');
            const seconds = String(localDate.getUTCSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function generateProblem() {
            let nums = [];
            let ops = [''];
            let temp, result;

            // ÈöèÊú∫ÈÄâÊã©Á¨¨‰∏Ä‰∏™‰∏Ä‰ΩçÊï∞Ôºà1-9Ôºâ
            nums.push(Math.floor(Math.random() * 9) + 1);
            temp = nums[0];

            // ÈöèÊú∫ÈÄâÊã©Êìç‰ΩúÁ¨¶ÂíåÁ¨¨‰∫å‰∏™Êï∞Â≠ó
            let op = Math.random() > 0.5 ? '+' : '-';
            let maxNum = op === '-' ? temp : 9; // Á°Æ‰øùÊó†Ë¥üÊï∞
            let num = Math.floor(Math.random() * maxNum) + 1;
            temp = op === '+' ? temp + num : temp - num;
            nums.push(num);
            ops.push(op);

            result = temp;

            // Á≠îÊ°àÂèØ‰ª•ÊòØ‰∏Ä‰ΩçÊï∞Êàñ‰∫å‰ΩçÊï∞Ôºà1-99Ôºâ
            if (result < 1 || result > 99) {
                return generateProblem(); // ÈÄíÂΩíÈáçËØï
            }

            const practiceArr = nums.map((num, i) => {
                let sign = ops[i] === '-' ? '-' : (i === 0 ? '' : '');
                return `<span>${sign}${num}</span>`;
            });
            const practiceText = practiceArr.join('<br>');

            const summaryArr = nums.map((num, i) => ops[i] + num);
            const summaryText = summaryArr.join(' ');

            return { practiceText, summaryText, answer: result };
        }

        function startPractice() {
            console.log('startPractice called');
            if (!userName || userName === 'Êú™Áü•') {
                document.getElementById('setupError').innerText = translations[language].errorNoName;
                return;
            }
            document.getElementById('setupError').innerText = '';
            numQuestions = parseInt(document.getElementById('numQuestions').value);
            problems = [];
            for (let i = 0; i < numQuestions; i++) {
                problems.push(generateProblem());
            }
            currentIndex = 0;
            startTime = new Date();
            document.getElementById('setup').style.display = 'none';
            document.getElementById('practice').style.display = 'block';
            document.getElementById('langToggle').style.display = 'none';
            showProblem();
        }

        function showProblem() {
            console.log(`showProblem: currentIndex=${currentIndex}, problems.length=${problems.length}`);
            if (currentIndex >= problems.length) {
                console.log('Transitioning to summary');
                showSummary();
                return;
            }
            document.getElementById('currentQuestion').innerText = currentIndex + 1;
            document.getElementById('questionTitle').innerHTML = translations[language].question.replace('{n}', `<span id="currentQuestion">${currentIndex + 1}</span>`);
            document.getElementById('problem').innerHTML = problems[currentIndex].practiceText;
            document.getElementById('problem').dataset.answer = problems[currentIndex].answer;
            document.getElementById('answer').value = '';
            document.getElementById('result').innerText = '';
        }

        function checkAnswer() {
            console.log(`checkAnswer: currentIndex=${currentIndex}`);
            const userAnswer = parseInt(document.getElementById('answer').value);
            const correctAnswer = parseInt(document.getElementById('problem').dataset.answer);
            if (isNaN(userAnswer)) {
                document.getElementById('result').innerText = translations[language].errorEnterAnswer;
                return;
            }
            problems[currentIndex].userAnswer = userAnswer;
            problems[currentIndex].correct = userAnswer === correctAnswer;
            currentIndex++;
            console.log(`checkAnswer: incremented currentIndex=${currentIndex}`);
            showProblem();
        }

        function drawShareCanvas() {
            const shareArea = document.getElementById('shareArea');
            const canvas = document.getElementById('shareCanvas');
            const ctx = canvas.getContext('2d');
            const width = shareArea.offsetWidth;
            const height = shareArea.offsetHeight + (language === 'en' ? 120 : 90);
            canvas.width = width;
            canvas.height = height;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
            const xLeft = 20;
            let y = 30;
            const lineHeight = 30;
            ctx.font = '20px bold Arial';
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            const xCenter = width / 2;
            ctx.fillText(translations[language].reportTitle, xCenter, y);
            y += lineHeight;
            if (language === 'en') {
                ctx.fillText('(One-Digit Two-Step', xCenter, y);
                y += lineHeight;
                ctx.fillText('Addition/Subtraction)', xCenter, y);
            } else {
                ctx.fillText(translations[language].reportSubtitle, xCenter, y);
            }
            y += lineHeight;
            ctx.textAlign = 'left';
            ctx.font = '16px bold Arial';
            ctx.fillText(`${translations[language].name}: ${document.getElementById('userNameDisplay').innerText}`, xLeft, y);
            y += lineHeight;
            ctx.font = '16px Arial';
            ctx.fillText(`${translations[language].correctCount}: ${document.getElementById('correctCount').innerText}`, xLeft, y);
            y += lineHeight;
            ctx.fillText(`${translations[language].totalTime}: ${document.getElementById('totalTime').innerText}`, xLeft, y);
            y += lineHeight;
            ctx.fillText(`${translations[language].completionTime}: ${document.getElementById('completionTime').innerText}`, xLeft, y);
            y += 2 * lineHeight;
            ctx.font = '14px Arial';
            ctx.fillStyle = '#666666';
            ctx.textAlign = 'center';
            ctx.fillText(translations[language].author, xCenter, y);
            return canvas;
        }

        function shareResult() {
            const canvas = drawShareCanvas();
            canvas.toBlob(blob => {
                const file = new File([blob], 'result.png', { type: 'image/png' });
                if (navigator.share && isMobile) {
                    navigator.share({
                        files: [file],
                        title: translations[language].reportTitle,
                        text: translations[language].shareText
                    }).catch(err => console.error('ÂàÜ‰∫´Â§±Ë¥•:', err));
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'result.png';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
        }

        function generatePDF() {
            const canvas = drawShareCanvas();
            const imgData = canvas.toDataURL('image/png');
            const imgProps = { width: canvas.width, height: canvas.height };
            const pdfImageHeight = (imgProps.height * 190) / imgProps.width;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            pdf.addImage(imgData, 'PNG', 10, 10, 190, pdfImageHeight);

            pdf.setLineWidth(0.5);
            pdf.setDrawColor(0, 0, 0);
            pdf.setFont('helvetica', 'normal');

            let y = 10 + pdfImageHeight + 10;
            const rowHeight = 10;
            const colWidths = [80, 40, 40, 30];
            const pageHeight = pdf.internal.pageSize.height - 20;

            function drawTableHeader() {
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text('QUESTION', 10 + colWidths[0] / 2, y + 7, { align: 'center' });
                pdf.text('YOUR ANSWER', 10 + colWidths[0] + colWidths[1] / 2, y + 7, { align: 'center' });
                pdf.text('CORRECTNESS', 10 + colWidths[0] + colWidths[1] + colWidths[2] / 2, y + 7, { align: 'center' });
                pdf.text('ANSWER', 10 + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] / 2, y + 7, { align: 'center' });
                y += rowHeight;
                pdf.line(10, y - rowHeight, 200, y - rowHeight);
                pdf.line(10, y, 200, y);
                let x = 10;
                colWidths.forEach(width => {
                    pdf.line(x, y - rowHeight, x, y);
                    x += width;
                });
                pdf.line(x, y - rowHeight, x, y);
            }

            drawTableHeader();

            problems.forEach((problem) => {
                if (y + rowHeight > pageHeight) {
                    pdf.addPage();
                    y = 10;
                    drawTableHeader();
                }

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                const maxWidth = colWidths[0] - 5;
                const questionText = pdf.splitTextToSize(problem.summaryText, maxWidth, { fontSize: 10 })[0];
                pdf.text(questionText, 10 + colWidths[0] / 2, y + 7, { align: 'center', maxWidth: maxWidth });

                if (problem.correct) {
                    pdf.setTextColor(0, 128, 128);
                } else {
                    pdf.setTextColor(255, 0, 0);
                }
                pdf.text((problem.userAnswer !== undefined ? problem.userAnswer.toString() : '-'), 10 + colWidths[0] + colWidths[1] / 2, y + 7, { align: 'center' });

                if (problem.correct) {
                    pdf.setTextColor(0, 128, 128);
                    pdf.text('CORRECT', 10 + colWidths[0] + colWidths[1] + colWidths[2] / 2, y + 7, { align: 'center' });
                } else {
                    pdf.setTextColor(255, 0, 0);
                    pdf.text('WRONG', 10 + colWidths[0] + colWidths[1] + colWidths[2] / 2, y + 7, { align: 'center' });
                }

                pdf.setTextColor(0, 0, 0);
                pdf.text(problem.answer.toString(), 10 + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] / 2, y + 7, { align: 'center' });

                pdf.line(10, y, 200, y);
                y += rowHeight;
                pdf.line(10, y, 200, y);
                let x = 10;
                colWidths.forEach(width => {
                    pdf.line(x, y - rowHeight, x, y);
                    x += width;
                });
                pdf.line(x, y - rowHeight, x, y);
            });

            pdf.save('report.pdf');
        }

        function showSummary() {
            console.log('showSummary called');
            document.getElementById('practice').style.display = 'none';
            document.getElementById('summary').style.display = 'block';
            document.getElementById('langToggle').style.display = 'block';
            const endTime = new Date();
            const timeTaken = Math.round((endTime - startTime) / 1000);
            const correctCount = problems.filter(p => p.correct).length;
            const percentage = (correctCount / numQuestions) * 100;
            let messageArray;
            if (percentage === 100) {
                messageArray = encouragementsByPercentage.fullMarks[language];
            } else if (percentage >= 80) {
                messageArray = encouragementsByPercentage.from80to100[language];
            } else if (percentage >= 60) {
                messageArray = encouragementsByPercentage.from60to80[language];
            } else if (percentage >= 40) {
                messageArray = encouragementsByPercentage.from40to60[language];
            } else if (percentage >= 10) {
                messageArray = encouragementsByPercentage.from10to40[language];
            } else {
                messageArray = encouragementsByPercentage.below10[language];
            }
            document.getElementById('userNameDisplay').innerText = userName;
            document.getElementById('correctCount').innerText = `${correctCount}/${numQuestions}`;
            document.getElementById('totalTime').innerText = `${timeTaken} ${translations[language].seconds}`;
            document.getElementById('completionTime').innerText = formatDateTime(endTime);
            document.getElementById('encouragement').innerText = messageArray[Math.floor(Math.random() * messageArray.length)];
            document.getElementById('practiceResults').innerText = translations[language].practiceResults;
            document.getElementById('nameLabel').innerText = translations[language].name;
            document.getElementById('correctCountLabel').innerText = translations[language].correctCount;
            document.getElementById('totalTimeLabel').innerText = translations[language].totalTime;
            document.getElementById('completionTimeLabel').innerText = translations[language].completionTime;
            document.getElementById('shareButton').innerText = translations[language].share;
            document.getElementById('pdfButton').innerText = translations[language].generatePDF;
            document.getElementById('returnHomeButton').innerText = translations[language].returnHome;
            document.getElementById('analysisTitle').innerText = translations[language].analysisTitle;
            document.getElementById('problemHeader').innerText = translations[language].problemHeader;
            document.getElementById('userAnswerHeader').innerText = translations[language].userAnswerHeader;
            document.getElementById('correctnessHeader').innerText = translations[language].correctnessHeader;
            document.getElementById('correctAnswerHeader').innerText = translations[language].correctAnswerHeader;
            document.getElementById('author').innerHTML = `${translations.zh.author}<br>${translations.en.author}`;
            document.getElementById('aiUsage').innerHTML = `${translations.zh.aiUsage}<br>${translations.en.aiUsage}`;
            const table = document.getElementById('summaryTable');
            table.innerHTML = '';
            problems.forEach((problem, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${problem.summaryText}</td>
                    <td>${problem.userAnswer !== undefined ? problem.userAnswer : '-'}</td>
                    <td class="${problem.correct ? 'correct' : 'incorrect'}">${problem.correct ? translations[language].correct : translations[language].incorrect}</td>
                    <td>${problem.answer}</td>
                `;
                table.appendChild(row);
            });
            document.title = translations[language].title;
        }

        function returnToHome() {
            window.location.href = 'index.html';
        }

        window.onload = () => {
            console.log('window.onload: Initializing');
            document.getElementById('setup').style.display = 'block';
            const answerInput = document.getElementById('answer');
            if (isMobile) {
                answerInput.readOnly = true;
                document.getElementById('keyboard').style.display = 'grid';
                answerInput.addEventListener('focus', () => {
                    answerInput.blur();
                });
            } else {
                document.getElementById('keyboard').style.display = 'none';
            }
            answerInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    console.log('Enter key pressed, calling checkAnswer');
                    checkAnswer();
                }
            });
            const submitButton = document.getElementById('submitButton');
            submitButton.addEventListener('click', () => {
                console.log('Submit button clicked');
                checkAnswer();
            });
            if (isMobile) {
                submitButton.addEventListener('touchstart', (event) => {
                    event.preventDefault();
                    console.log('Submit button touched');
                    checkAnswer();
                });
            }
            const buttons = document.querySelectorAll('.keyboard button');
            buttons.forEach(button => {
                const key = button.dataset.key;
                button.addEventListener('click', () => {
                    console.log(`Keyboard button ${key} clicked`);
                    inputKey(key);
                });
                if (isMobile) {
                    button.addEventListener('touchstart', (event) => {
                        event.preventDefault();
                        console.log(`Keyboard button ${key} touched`);
                        inputKey(key);
                    });
                }
            });
            if (!localStorage.getItem('userName')) {
                document.getElementById('setupError').innerText = translations[language].errorNoName;
                document.getElementById('startButton').disabled = true;
            }
            document.getElementById('langToggle').style.display = 'none';
            document.title = translations[language].title;
            document.getElementById('numQuestions').previousElementSibling.innerText = `${translations.zh.selectQuestions} / ${translations.en.selectQuestions}`;
            document.getElementById('startButton').innerText = `${translations.zh.startPractice} / ${translations.en.startPractice}`;
            document.getElementById('answer').placeholder = `${translations.zh.enterAnswer} / ${translations.en.enterAnswer}`;
            document.getElementById('submitButton').innerText = `${translations.zh.submit} / ${translations.en.submit}`;
            document.getElementById('questionTitle').innerHTML = `${translations.zh.question.replace('{n}', '<span id="currentQuestion">1</span>')} / ${translations.en.question.replace('{n}', '<span id="currentQuestion">1</span>')}`;
        };
    </script>
</body>
</html>